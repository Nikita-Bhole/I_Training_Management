{% extends "subjects/base.html" %}
{% load static %}

{% block title %}Batches{% endblock %}

{% block content %}
<div class="container mt-4">
    <h4>Batches</h4>

    
    <div class="mb-3 d-flex justify-content-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBatchModal">
            Add Batch
        </button>
    </div>

    
    <div class="row mb-3">
        <div class="col-md-4">
            <label>Course</label>
            <select id="filter-course" class="form-control select2">
                <option value="">All Courses</option>
                {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label>Subject</label>
            <select id="filter-subject" class="form-control select2">
                <option value="">All Subjects</option>
                {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label>Teacher</label>
            <select id="filter-teacher" class="form-control select2">
                <option value="">All Teachers</option>
                {% for teacher in teachers %}
                    <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="mb-3 text-end">
        <button id="clear-filters" class="btn btn-secondary">Clear Filters</button>
    </div>

    
    <div id="batch-data-list">
        {% include "batches/batch_table.html" %}
    </div>
</div>


<div class="modal fade" id="addBatchModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form id="addBatchForm">{% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label>Batch Name</label>
            <input type="text" name="name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Course</label>
            <select name="course" id="add-course" class="form-control select2" required>
              <option value="">Select Course</option>
              {% for course in courses %}
                <option value="{{ course.id }}">{{ course.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3" id="inline-subject-teacher-add"></div>

          <div class="mb-3">
            <label>Start Date</label>
            <input type="date" name="start_date" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Duration (months)</label>
            <input type="number" name="duration" min="1" class="form-control" required>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>


<div class="modal fade" id="viewBatchModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Batch Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="viewBatchBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="editBatchModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form id="editBatchForm">{% csrf_token %}
      <input type="hidden" name="id" id="edit-id">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Batch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label>Batch Name</label>
            <input type="text" name="name" id="edit-name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Course</label>
            <select name="course" id="edit-course" class="form-control select2" required>
              <option value="">Select Course</option>
              {% for course in courses %}
                <option value="{{ course.id }}">{{ course.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3" id="inline-subject-teacher-edit"></div>

          <div class="mb-3">
            <label>Start Date</label>
            <input type="date" name="start_date" id="edit-start-date" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Duration (months)</label>
            <input type="number" name="duration" id="edit-duration" min="1" class="form-control" required>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(function(){
  
  $('.select2').select2({width:'100%'});
  $('#add-course').select2({dropdownParent:$('#addBatchModal'), width:'100%'});
  $('#edit-course').select2({dropdownParent:$('#editBatchModal'), width:'100%'});

  function loadBatches(url="{% url 'batch_list' %}", filters={}) {
    $.get(url, filters, function(data){
      $('#batch-data-list').html(data);
    });
  }

  
  function showPreview(courseId, type='add', selectedData={}) {
    if(!courseId) return;
    $.get("{% url 'get_subject_teacher' %}", {course_id: courseId}, function(res){
        let html = `<h6>Course: <b>${res.course}</b></h6><hr>`;
        const container = type === 'add' ? '#inline-subject-teacher-add' : '#inline-subject-teacher-edit';
        if(res.subjects.length === 0){
            html += `<p class="text-danger">No subjects found</p>`;
            $(container).html(html);
            return;
        }
        res.subjects.forEach((s)=>{
            html += `<div class="mb-3">
                        <label>${s.name} - Select Teacher(s)</label>
                        <select name="subject_teachers[${s.id}][]" class="form-control teacher-select select2" multiple="multiple"></select>
                     </div>`;
        });
        $(container).html(html);
        res.subjects.forEach((s)=>{
            const select = $(container).find(`select[name="subject_teachers[${s.id}][]"]`);
            s.teachers.forEach(t => {
                const option = new Option(t.name, t.id, false, false);
                select.append(option);
            });
            if(selectedData[s.id]){
                select.val(selectedData[s.id]);
            }
            select.select2({dropdownParent: $(container), width:'100%'});
        });
    });
  }

  
  $('#add-course').change(function(){ showPreview(this.value,'add'); });

  $('#addBatchForm').submit(function(e){
      e.preventDefault();
      let formData = new FormData(this);
      let subjectTeachers = {};
      $('#inline-subject-teacher-add select.teacher-select').each(function(){
          let subjectId = $(this).attr('name').match(/\d+/)[0];
          subjectTeachers[subjectId] = $(this).val();  
      });
      formData.append('subject_teachers', JSON.stringify(subjectTeachers));
      $.ajax({
          url: "{% url 'batch_list' %}",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function(res){
              $('#addBatchModal').modal('hide');
              loadBatchesWithFilters();
              Swal.fire("Added","Batch added successfully","success");
          }
      });
  });

  
  $(document).on('click','.editBtn', function(){
      let row = $(this);
      $('#edit-id').val(row.data('id'));
      $('#edit-name').val(row.data('name'));
      $('#edit-course').val(row.data('course')).trigger('change');
      $('#edit-start-date').val(row.data('start_date'));
      $('#edit-duration').val(row.data('duration'));
      let selectedData = row.data('subject_teacher_map');
      showPreview(row.data('course'), 'edit', selectedData);
      $('#editBatchModal').modal('show');
  });

  $('#editBatchForm').submit(function(e){
      e.preventDefault();
      let formData = new FormData(this);
      let subjectTeachersEdit = {};
      $('#inline-subject-teacher-edit select.teacher-select').each(function(){
          let subjectId = $(this).attr('name').match(/\d+/)[0];
          subjectTeachersEdit[subjectId] = $(this).val(); 
      });
      formData.append('subject_teachers', JSON.stringify(subjectTeachersEdit));
      $.ajax({
          url: "{% url 'batch_list' %}",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function(res){
              $('#editBatchModal').modal('hide');
              loadBatchesWithFilters();
              Swal.fire("Updated","Batch updated successfully","success");
          }
      });
  });

  
  $(document).on('click', '.viewBtn', function() {
    let rawData = $(this).attr('data-subject-teacher');
    let subject_teacher_map = {};

    if(rawData.trim() !== '{}'){
        rawData.split(',').forEach(pair => {
            let [subject, teacher] = pair.split(':').map(s => s.trim().replace(/^"|"$/g, ''));
            subject_teacher_map[subject] = teacher;
        });
    }

    let html = `<p><strong>Batch Name:</strong> ${$(this).data('batch-name')}</p>
                <p><strong>Course:</strong> ${$(this).data('course-name')}</p>
                <p><strong>Start Date:</strong> ${$(this).data('start-date')}</p>
                <p><strong>Duration (months):</strong> ${$(this).data('duration')}</p>
                <p><strong>Subjects & Teachers:</strong></p>`;

    if(Object.keys(subject_teacher_map).length === 0){
        html += `<p>No subject-teacher mapping</p>`;
    } else {
        html += `<table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Subject</th>
                            <th>Teacher(s)</th>
                        </tr>
                    </thead>
                    <tbody>`;
        for(let sub in subject_teacher_map){
            html += `<tr>
                        <td>${sub}</td>
                        <td>${subject_teacher_map[sub]}</td>
                     </tr>`;
        }
        html += `</tbody></table>`;
    }

    $('#viewBatchBody').html(html);
    $('#viewBatchModal').modal('show');
  });

  
  $(document).on('click','.deleteBtn',function(){
      let id=$(this).data('id');
      Swal.fire({title:"Are you sure?",icon:"warning",showCancelButton:true})
      .then(r=>{
        if(r.isConfirmed){
          $.post("{% url 'batch_list' %}", {delete_id:id, csrfmiddlewaretoken:'{{ csrf_token }}'}, ()=>{
            loadBatchesWithFilters();
            Swal.fire("Deleted","Batch archived","success");
          });
        }
      });
  });

  
  function loadBatchesWithFilters(pageUrl="{% url 'batch_list' %}") {
      let filters = {
          course: $('#filter-course').val(),
          subject: $('#filter-subject').val(),
          teacher: $('#filter-teacher').val()
      };
      loadBatches(pageUrl, filters);
  }

  $('#filter-course, #filter-subject, #filter-teacher').change(function() {
      loadBatchesWithFilters();
  });

  $('#clear-filters').click(function() {
      $('#filter-course, #filter-subject, #filter-teacher').val('').trigger('change');
      loadBatchesWithFilters();
  });

  $(document).on('click','.page-link',function(e){
      e.preventDefault();
      loadBatchesWithFilters($(this).attr('href'));
  });

  loadBatchesWithFilters();
});
</script>
{% endblock %}
