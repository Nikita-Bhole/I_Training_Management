{% extends "subjects/base.html" %}
{% load static %}

{% block title %}Students{% endblock %}

{% block content %}
<div class="container mt-4">

    <h4>Students</h4>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <label class="me-2 mb-0">Filter by Student:</label>
            <select id="student-filter" class="form-control" multiple style="width: 300px;">
            {% for name in students %}
                <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
            </select>
        </div>

        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
            Add Student
        </button>
    </div>

    <div id="student-data-list">
        {% include "students/student_table.html" %}
    </div>

</div>


<div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="addStudentForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Student Name</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Batch</label>
            <select name="batch" class="form-control" required>
              <option value="">Select Batch</option>
              {% for b in batches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>


<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editStudentForm">
      {% csrf_token %}
      <input type="hidden" id="edit-id" name="id">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Student Name</label>
            <input type="text" name="name" id="edit-name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Batch</label>
            <select name="batch" id="edit-batch" class="form-control" required>
              <option value="">Select Batch</option>
              {% for b in batches %}
                <option value="{{ b.id }}">{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$('#student-filter').select2({
    width: '300px',
    placeholder: 'Select Student(s)',
    allowClear: true
});

function cleanModal(modalId) {
    const modal = $(modalId);
    modal.modal('hide');
    setTimeout(() => {
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        modal.find('form')[0].reset();
    }, 300);
}

function loadStudents(page = 1) {
    const studentNames = $('#student-filter').val();
    $.ajax({
        url: "{% url 'student_list' %}",
        type: "GET",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: { page: page, 'student_names[]': studentNames },
        success: function(response) {
            $("#student-data-list").html(response);
        }
    });
}

$('#student-filter').on('change', function() {
    loadStudents();
});

$(document).on('submit', '#addStudentForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'student_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#addStudentModal');
            loadStudents();
            Swal.fire("Added!", "Student added successfully.", "success");
        }
    });
});

$(document).on('click', '.editBtn', function() {
    $('#edit-id').val($(this).data('id'));
    $('#edit-name').val($(this).data('name'));
    $('#edit-batch').val($(this).data('batch'));
    $('#editStudentModal').modal('show');
});

$(document).on('submit', '#editStudentForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'student_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#editStudentModal');
            loadStudents();
            Swal.fire("Saved!", "Student updated successfully.", "success");
        }
    });
});

$(document).on('click', '.deleteBtn', function() {
    let id = $(this).data('id');
    Swal.fire({
        title: "Are you sure?",
        text: "This student will be archived!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!"
    }).then((result) => {
        if(result.isConfirmed){
            $.ajax({
                url: "{% url 'student_list' %}",
                type: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                data: { delete_id: id, csrfmiddlewaretoken: '{{ csrf_token }}' },
                success: function() {
                    loadStudents();
                    Swal.fire("Deleted!", "Student archived successfully.", "success");
                }
            });
        }
    });
});

$(document).on('click', '.page-link', function(e){
    e.preventDefault();
    let page = $(this).attr('href').split('page=')[1];
    loadStudents(page);
});

$(document).ready(function() {
    loadStudents();
});
</script>
{% endblock %}
