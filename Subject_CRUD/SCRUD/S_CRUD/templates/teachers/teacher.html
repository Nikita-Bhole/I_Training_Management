{% extends "subjects/base.html" %}
{% load static %}

{% block title %}Teachers{% endblock %}

{% block content %}
<div class="container mt-4">

    <h4>Teachers</h4>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <label class="me-2 mb-0">Filter by Subject:</label>
            <select id="subject-filter" class="form-control" multiple style="width: 200px;">
                {% for subject in subjects %}
                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
        </div>

        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeacherModal">
            Add Teacher
        </button>
    </div>

    <div id="teacher-data-list">
        {% include "teachers/teacher_table.html" %}
    </div>

</div>

<div class="modal fade" id="addTeacherModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="addTeacherForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Teacher</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Teacher ID</label>
              <input type="text" name="teacher_id" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label>Teacher Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>
          </div>
          <div class="mb-3">
            <label>Subjects</label>
            <select name="subjects[]" id="add-subjects" class="form-control" multiple required>
              {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="editTeacherModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editTeacherForm">
      {% csrf_token %}
      <input type="hidden" id="edit-id" name="id">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Teacher</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Teacher ID</label>
              <input type="text" name="teacher_id" id="edit-teacher-id" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label>Teacher Name</label>
              <input type="text" name="name" id="edit-name" class="form-control" required>
            </div>
          </div>
          <div class="mb-3">
            <label>Subjects</label>
            <select name="subjects[]" id="edit-subjects" class="form-control" multiple required>
              {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function cleanModal(modalId) {
    const modal = $(modalId);
    modal.modal('hide');
    setTimeout(() => {
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        modal.find('form')[0].reset();
        modal.find('select').val(null).trigger('change');
    }, 300);
}

function loadTeachers(page = 1) {
    const selectedSubjects = $('#subject-filter').val();
    $.ajax({
        url: "{% url 'teacher_list' %}",
        type: "GET",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: { page: page, subject: selectedSubjects },
        traditional: true,
        success: function(response) {
            $("#teacher-data-list").html(response);
        }
    });
}

$('#subject-filter').select2({ width: '200px', placeholder: 'Select Subject' });

$('#addTeacherModal').on('shown.bs.modal', function () {
    if (!$('#add-subjects').hasClass('select2-hidden-accessible')) {
        $('#add-subjects').select2({ width: '100%', dropdownParent: $('#addTeacherModal') });
    }
});

$('#editTeacherModal').on('shown.bs.modal', function () {
    if (!$('#edit-subjects').hasClass('select2-hidden-accessible')) {
        $('#edit-subjects').select2({ width: '100%', dropdownParent: $('#editTeacherModal') });
    }
});

$('#subject-filter').on('change', function() {
    loadTeachers();
});

$(document).on('submit', '#addTeacherForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'teacher_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#addTeacherModal');
            loadTeachers();
            Swal.fire("Added!", "Teacher added successfully.", "success");
        }
    });
});

$(document).on('click', '.editBtn', function() {
    let subjects = $(this).data('subjects').toString().split(',');

    $('#edit-id').val($(this).data('id'));
    $('#edit-teacher-id').val($(this).data('teacherid'));
    $('#edit-name').val($(this).data('name'));

    $('#editTeacherModal').modal('show');

    setTimeout(() => {
        $('#edit-subjects').val(subjects).trigger('change');
    }, 200);
});

$(document).on('submit', '#editTeacherForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'teacher_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#editTeacherModal');
            loadTeachers();
            Swal.fire("Saved!", "Teacher updated successfully.", "success");
        }
    });
});

$(document).on('click', '.deleteBtn', function() {
    let id = $(this).data('id');
    Swal.fire({
        title: "Are you sure?",
        text: "This teacher will be archived!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!"
    }).then((result) => {
        if(result.isConfirmed){
            $.ajax({
                url: "{% url 'teacher_list' %}",
                type: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                data: {
                    delete_id: id,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function() {
                    loadTeachers();
                    Swal.fire("Deleted!", "Teacher archived successfully.", "success");
                }
            });
        }
    });
});

$(document).on('click', '#teacher-data-list .pagination a', function(e) {
    e.preventDefault();
    let page = $(this).attr('href').split('page=')[1];
    loadTeachers(page);
});

$(document).ready(function() {
    loadTeachers();
});
</script>
{% endblock %}
