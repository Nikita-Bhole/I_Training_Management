{% extends "subjects/base.html" %}
{% load static %}

{% block title %}Students{% endblock %}

{% block content %}
<div class="container mt-4">

    <h4>Students</h4>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
            Add Student
        </button>
    </div>

    <div id="student-data-list">
        {% include "students/student_table.html" %}
    </div>

</div>

<div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="addStudentForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Student Name</label>
            <input type="text" name="name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Subjects</label>
            <select name="subjects[]" id="add-subjects" class="form-control" multiple required>
              {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label>Courses</label>
            <select name="courses[]" id="add-courses" class="form-control" multiple required>
              {% for course in courses %}
                <option value="{{ course.id }}">{{ course.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editStudentForm">
      {% csrf_token %}
      <input type="hidden" id="edit-id" name="id">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Student Name</label>
            <input type="text" name="name" id="edit-name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label>Subjects</label>
            <select name="subjects[]" id="edit-subjects" class="form-control" multiple required>
              {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label>Courses</label>
            <select name="courses[]" id="edit-courses" class="form-control" multiple required>
              {% for course in courses %}
                <option value="{{ course.id }}">{{ course.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function cleanModal(modalId) {
    const modal = $(modalId);
    modal.modal('hide');
    setTimeout(() => {
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        modal.find('form')[0].reset();
        modal.find('select').val(null).trigger('change');
    }, 300);
}

function loadStudents(url="{% url 'student_list' %}") {
    $.ajax({
        url: url,
        type: "GET",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(response) {
            $("#student-data-list").html(response);
        }
    });
}

$('#add-subjects, #add-courses').select2({ width: '100%', dropdownParent: $('#addStudentModal') });
$('#edit-subjects, #edit-courses').select2({ width: '100%', dropdownParent: $('#editStudentModal') });

$(document).on('submit', '#addStudentForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'student_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#addStudentModal');
            loadStudents();
            Swal.fire("Added!", "Student added successfully.", "success");
        }
    });
});

$(document).on('click', '.editBtn', function() {
    let subjects = $(this).data('subjects').toString().split(',');
    let courses = $(this).data('courses').toString().split(',');

    $('#edit-id').val($(this).data('id'));
    $('#edit-name').val($(this).data('name'));
    $('#editStudentModal').modal('show');

    setTimeout(() => {
        $('#edit-subjects').val(subjects).trigger('change');
        $('#edit-courses').val(courses).trigger('change');
    }, 200);
});

$(document).on('submit', '#editStudentForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'student_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#editStudentModal');
            loadStudents();
            Swal.fire("Saved!", "Student updated successfully.", "success");
        }
    });
});

$(document).on('click', '.deleteBtn', function() {
    let id = $(this).data('id');
    Swal.fire({
        title: "Are you sure?",
        text: "This student will be archived!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!"
    }).then((result) => {
        if(result.isConfirmed){
            $.ajax({
                url: "{% url 'student_list' %}",
                type: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                data: { delete_id: id, csrfmiddlewaretoken: '{{ csrf_token }}' },
                success: function() {
                    loadStudents();
                    Swal.fire("Deleted!", "Student archived successfully.", "success");
                }
            });
        }
    });
});

$(document).on('click', '.page-link', function(e){
    e.preventDefault();
    let url = $(this).attr('href');
    loadStudents(url);
});

$(document).ready(function() {
    loadStudents();
});
</script>
{% endblock %}
