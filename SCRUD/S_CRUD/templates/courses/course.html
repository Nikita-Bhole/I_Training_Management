{% extends "subjects/base.html" %}
{% load static %}

{% block title %}Courses{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Courses</h4>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCourseModal">
            Add Course
        </button>
    </div>

    <div id="course-data-list">
        {% include "courses/course_table.html" %}
    </div>

</div>

<div class="modal fade" id="addCourseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="addCourseForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Course ID</label>
              <input type="text" name="course_id" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label>Course Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>
          </div>
          <div class="mb-3">
            <label>Subjects</label>
            <select name="subjects[]" id="add-subjects" class="form-control" multiple required>
              {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="editCourseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editCourseForm">
      {% csrf_token %}
      <input type="hidden" id="edit-id" name="id">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Course</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label>Course ID</label>
              <input type="text" name="course_id" id="edit-course-id" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label>Course Name</label>
              <input type="text" name="name" id="edit-name" class="form-control" required>
            </div>
          </div>
          <div class="mb-3">
            <label>Subjects</label>
            <select name="subjects[]" id="edit-subjects" class="form-control" multiple required>
              {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
function cleanModal(modalId) {
    const modal = $(modalId);
    modal.modal('hide');
    setTimeout(() => {
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        modal.find('form')[0].reset();
        modal.find('select').val(null).trigger('change');
    }, 300);
}

function loadCourses(page = 1) {
    $.ajax({
        url: "{% url 'course_list' %}",
        type: "GET",
        data: { page: page },
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(response) {
            $("#course-data-list").html(response);
        }
    });
}

$(document).on('click', '#course-data-list .pagination a', function (e) {
    e.preventDefault();
    let page = $(this).attr('href').split('page=')[1];
    loadCourses(page);
});

$('#addCourseModal').on('shown.bs.modal', function () {
    if (!$('#add-subjects').hasClass('select2-hidden-accessible')) {
        $('#add-subjects').select2({ width: '100%', dropdownParent: $('#addCourseModal') });
    }
});

$('#editCourseModal').on('shown.bs.modal', function () {
    if (!$('#edit-subjects').hasClass('select2-hidden-accessible')) {
        $('#edit-subjects').select2({ width: '100%', dropdownParent: $('#editCourseModal') });
    }
});

$(document).on('submit', '#addCourseForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'course_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#addCourseModal');
            loadCourses();
            Swal.fire("Added!", "Course added successfully.", "success");
        }
    });
});

$(document).on('click', '.editBtn', function() {
    let subjects = $(this).data('subjects').toString().split(',');
    $('#edit-id').val($(this).data('id'));
    $('#edit-course-id').val($(this).data('courseid'));
    $('#edit-name').val($(this).data('name'));
    $('#editCourseModal').modal('show');
    setTimeout(() => {
        $('#edit-subjects').val(subjects).trigger('change');
    }, 200);
});

$(document).on('submit', '#editCourseForm', function(e) {
    e.preventDefault();
    $.ajax({
        url: "{% url 'course_list' %}",
        type: "POST",
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        data: $(this).serialize(),
        success: function() {
            cleanModal('#editCourseModal');
            loadCourses();
            Swal.fire("Saved!", "Course updated successfully.", "success");
        }
    });
});

$(document).on('click', '.deleteBtn', function() {
    let id = $(this).data('id');
    Swal.fire({
        title: "Are you sure?",
        text: "This course will be archived!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!"
    }).then((result) => {
        if(result.isConfirmed){
            $.ajax({
                url: "{% url 'course_list' %}",
                type: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                data: { delete_id: id, csrfmiddlewaretoken: '{{ csrf_token }}' },
                success: function() {
                    loadCourses();
                    Swal.fire("Deleted!", "Course archived successfully.", "success");
                }
            });
        }
    });
});

$(document).ready(function() {
    loadCourses();
});
</script>
{% endblock %}
